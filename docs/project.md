# SearchFace プロジェクト設定

## プロジェクト概要
- プロジェクト名: SearchFace
- 目的: 顔画像の類似度検索システム
- 主要技術: Python, FAISS, SQLite, face_recognition, Next.js

## ディレクトリ構成
```
SearchFace/
├── .cursorrules          # プロジェクト設定
├── requirements.txt      # 依存関係ファイル
├── data/                 # データディレクトリ
│   ├── images/          # 顔画像保存用
│   │   ├── base/       # 基準画像ディレクトリ
│   │   └── collected/  # 収集した画像ディレクトリ
│   ├── face_database.db # SQLiteデータベース
│   └── face.index       # FAISSインデックス
├── src/                 # ソースコード
│   ├── database/        # データベース関連
│   ├── face/           # 顔認識関連
│   ├── image/          # 画像処理関連
│   ├── utils/          # 共通ユーティリティ
│   ├── api/            # API実装
│   │   ├── routes/     # ルーティング定義
│   │   └── models/     # リクエスト/レスポンスモデル
│   ├── core/           # コア機能
│   │   ├── errors.py   # エラーコード定義
│   │   ├── exceptions.py # カスタム例外
│   │   └── middleware.py # ミドルウェア
│   └── run_api.py      # FastAPIアプリケーション定義とサーバー起動（uvicorn、ホットリロード設定）
├── frontend/           # フロントエンド実装
│   ├── app/           # Next.js App Router
│   ├── components/    # Reactコンポーネント
│   ├── styles/        # スタイル定義
│   └── public/        # 静的ファイル
├── tests/              # テストコード
└── docs/               # ドキュメント
    ├── design.md      # 設計資料
    └── api.md         # API仕様
```

## 顔データ管理ルール
- 1人につき複数枚の画像を登録可能
- 画像ファイル形式: .jpg, .jpeg, .png
- 画像ファイル名: 人物名.jpg
- メタデータ: JSON形式で保存
- 同一画像の重複登録は防止

## 類似度検索設定
- 検索結果数: デフォルト5件
- 類似度計算方法: 距離ベース
- 閾値設定:
  - 距離0.4以上: 異なる人物の可能性が高い（50%未満）
  - 距離0.6以上: ほぼ確実に異なる人物（0%）

## 画像収集設定
### 検索設定
- 検索エンジン: Google Custom Search API
- 検索クエリ: 人物名 + "av女優"
- セーフサーチ: 無効
- 検索結果数: 10件

### 画像検証
- 類似度閾値: 0.55
- 最大顔検出数: 1
- 検証項目:
  - 顔の検出
  - 類似度の計算
  - 複数顔のチェック

### 画像保存
- 有効な画像: collected/人物名/人物名_N.jpg
- 無効な画像: collected/人物名/all_images/人物名_N_invalid.jpg
- 保存形式: JPEG

### エラーハンドリング
- タイムアウト設定:
  - 接続タイムアウト: 5秒
  - 読み取りタイムアウト: 30秒
- リトライ設定:
  - 最大リトライ回数: 3回
  - リトライ間隔: 1秒

## 注意事項
- 顔データの取り扱いには注意が必要
- プライバシー保護に配慮
- データベースの整合性を維持
- パフォーマンスに注意（大量データ処理時）

## 開発手順
### 1. 要件の明確化と計画立案
- ユーザーの要求を正確に理解し、以下の点を明確にする
  - 機能要件（何を実装するか）
  - 非機能要件（性能、セキュリティ、保守性など）
  - 制約条件（技術的制約、時間的制約など）
- 不明点がある場合は、以下の手順で解消する
  1. 具体的な質問を整理
  2. ユーザーと対話して要件を明確化
  3. 合意した内容を文書化
- 計画立案のポイント
  - 実装の優先順位付け
  - 必要なリソースの見積もり
  - リスクの洗い出しと対策

### 2. 実装プロセス
- 計画に基づいて忠実に実装を行う
- コーディング規約の遵守
  - PEP 8に準拠
  - 型ヒントの適切な使用
  - ドキュメンテーション文字列の記述
- コードレビューの実施
  - 機能の正確性
  - パフォーマンス
  - セキュリティ
  - 保守性

### 3. ドキュメント更新
- 仕様・要件・設計の変更があった場合、以下のドキュメントを更新
  - `docs/project.md`: プロジェクト全体の設定
  - `docs/python.md`: Python開発に関する設定
  - `docs/db.md`: データベースに関する設定
  - `docs/design.md`: 設計資料
  - `docs/api.md`: API仕様
  - `docs/frontend.md`: フロントエンド開発に関する設定
- ドキュメント更新のタイミング
  - 要件変更時
  - 設計変更時
  - 実装完了時
- 更新内容の確認
  - 変更内容の正確性
  - ドキュメント間の整合性
  - 参照関係の適切性

### 4. 品質管理
- コード品質の確保
  - 静的解析ツールの活用
  - コードレビューの実施
  - テストカバレッジの確認
- パフォーマンスの確認
  - 処理時間の計測
  - メモリ使用量の確認
  - ボトルネックの特定
- セキュリティの確認
  - 脆弱性スキャン
  - セキュリティベストプラクティスの遵守
  - プライバシー保護の確認
